---
title: Vite 与传统构建工具
date: 2023/8/29
type: frontend
meta:
  - name: description
    content: 介绍 Vite 与传统构建工具的区别，以及 Vite 在开发环境和生产环境下采用不同的打包构建策略
---

[[toc]]

对于大型项目，过去的 Webpack 这种基于 bundle 的打包构建工具需要花费的时间很长，对于开发者的开发体验很不友好。而基于原生 ESM 的 Vite 便能很好的解决这个问题。

## 区别

Vite 将应用的模块分为<u>依赖</u>和<u>源码</u>两类。

**依赖**指的是项目依赖的组件库，而**源码**则是项目中的代码文件。

在开发环境下，Vite 会使用 `esbuild` 对依赖进行预构建，将许多内部模块的 ESM 依赖项转换为单个模块，避免发送大量请求。同时将构建的依赖项缓存在 <u>node_modules/.vite</u> 中。

对于源码，Vite 会以**原生 ESM 方式**去向浏览器提供。浏览器会根据 ESM 语法自动导入依赖的模块，而 Vite 只需要在浏览器请求这些模块时，去将这些源码进行转换后提供即可。也就是说 Vite 把一部分的打包工作交给了浏览器去执行，Vite 不需要去做依赖分析构建，浏览器会根据 ESM 获取依赖的模块。而这也是与传统构建工具不同的一点，传统构建工具一般都需要对应用所有的模块先进行依赖分析，根据生成的 AST 去构建一个 bundle 提供给浏览器。

除此之外，Vite 还利用了浏览器缓存来加速整个页面的重新加载。源码模块的请求会采用 <u>304</u> 进行协商缓存，而依赖模块的请求则会通过    <u>Cache-Control</u> 进行强缓存。

## 生产环境

虽然 Vite 在开发环境下很好地利用了浏览器的本身的特性加快了构建的速度，但在生成环境下仍然需要进行打包。这是由于嵌套导入的模块会导致额外的请求。为了在生产环境中获得最佳的加载性能，仍然需要将代码进行 tree-shaking、懒加载和 chunk 分割。但要确保开发服务器和生产环境构建之间的输出和行为一致并不容易，Vite 也对此做了相应的优化。

在最终的打包构建阶段，Vite 会采用 `Rollup` 进行打包。不又采用 `esbuild` 的原因在于 Vite 目前的插件 API 与使用  `esbuild`  作为打包器并不兼容。尽管 `esbuild` 速度更快，但 Vite 选择了支持更灵活的插件 API 的 `Rollup`，Vite 开发团队认为 `Rollup` 提供了更好的性能与灵活性方面的权衡。