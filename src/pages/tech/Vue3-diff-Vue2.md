---
title: Vue3中Diff算法的改进
date: 2023/8/29
type: tech
---

# Vue3中Diff算法的改进

大家都知道，Vue3中采用的diff算法为快速diff算法，而Vue2采用的为双端diff算法。快速diff算法与双端diff算法的重要区别在于，快速diff算法在进行diff之前会进行预处理，对于前置和后置相同的节点便不参与后续的diff比对，同时根据剩余的vnode生成最长递增子序列来协助后续的diff。除了算法本身之外，Vue3还做了有利于diff效率的其它改进。

## 静态提升

对于模板中完全静态的元素，那就没有必要在重新渲染时再次创建和diff它们。Vue 编译器自动地会提升这部分vnode创建函数到这个模板的渲染函数之外，并在每次渲染时都使用这份相同的vnode，渲染器知道新旧vnode在这部分是完全相同的，所以会完全跳过对它们的差异比对。

此外，当有足够多连续的静态元素时，它们还会再被压缩在一个静态vnode中，这些静态节点便可以通过innerHTML直接挂载。同时还会缓存这些DOM节点，如果这些节点在其他地方被复用，那么还会使用cloneNode()方法来克隆这些节点。

## 更新类型标记（Patch Flag）

模板在渲染时，会为每个元素需要更新（动态）的内容，比如元素的属性，生成相应的patch flag。一个元素可以有多个patch flag，它们会被合并成一个数字。在patch（打补丁）时通过将patch flag与各个类型值进行位运算来判断是否需要更新，来快速进行patch。

## Block Tree

整个模板只有一个Block，<u>v-if</u><u>和v-for</u>指令会创建一个新的Block节点。生成的虚拟DOM树会被打平为一个数组，仅包含所有动态的后代节点。当这个组件需要重渲染时，只需要遍历这个打平的树而非整棵树，从而减少了需要遍历的节点数量。模板中任何的静态部分都会被略过。